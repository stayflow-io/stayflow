// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== MULTITENANCY ====================

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?  // URL da logo do tenant
  plan      String   @default("starter")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users        User[]
  properties   Property[]
  owners       Owner[]
  reservations Reservation[]
  tasks        Task[]
  transactions Transaction[]
  templates    MessageTemplate[]
}

model User {
  id           String    @id @default(cuid())
  tenantId     String
  email        String    @unique
  name         String
  passwordHash String
  role         UserRole  @default(OPERATOR)
  phone        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  tenant       Tenant        @relation(fields: [tenantId], references: [id])
  tasks        Task[]
  transactions Transaction[]
  owner        Owner?
}

enum UserRole {
  ADMIN
  MANAGER
  OPERATOR
  OWNER
}

// ==================== PROPERTIES ====================

model Owner {
  id                String    @id @default(cuid())
  tenantId          String
  userId            String?   @unique
  name              String
  email             String
  phone             String?
  document          String?   // CPF/CNPJ
  pixKey            String?
  bankAccount       Json?     // { bank, agency, account }
  commissionPercent Decimal   @default(20)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  deletedAt         DateTime?

  tenant     Tenant        @relation(fields: [tenantId], references: [id])
  user       User?         @relation(fields: [userId], references: [id])
  properties Property[]
  units      Unit[]
  payouts    OwnerPayout[]

  @@index([tenantId])
  @@index([tenantId, deletedAt])
  @@index([email])
}

model Property {
  id          String         @id @default(cuid())
  tenantId    String
  ownerId     String?        // Opcional - owner padrão das units (se null, cada unit tem seu owner)
  name        String         // Ex: "Edifício Mar Azul", "Casa da Praia"
  address     String
  city        String
  state       String
  zipcode     String?
  description String?
  amenities   String[]       // Amenidades do prédio/complexo
  status      PropertyStatus @default(ACTIVE)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  deletedAt   DateTime?

  tenant         Tenant            @relation(fields: [tenantId], references: [id])
  owner          Owner?            @relation(fields: [ownerId], references: [id])
  units          Unit[]
  channels       PropertyChannel[]

  @@index([tenantId, status])
  @@index([ownerId])
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

model Unit {
  id              String     @id @default(cuid())
  propertyId      String
  ownerId         String?    // Se null, herda do Property
  name            String     // Ex: "Apto 101", "Suíte Master", ou nome único se property tem só 1 unit
  bedrooms        Int
  bathrooms       Int
  maxGuests       Int
  description     String?
  amenities       String[]   // Amenidades específicas da unidade
  cleaningFee     Decimal    @default(0)
  adminFeePercent Decimal    @default(20)
  status          UnitStatus @default(ACTIVE)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt
  deletedAt       DateTime?

  property       Property          @relation(fields: [propertyId], references: [id])
  owner          Owner?            @relation(fields: [ownerId], references: [id])
  photos         UnitPhoto[]
  reservations   Reservation[]
  calendarBlocks CalendarBlock[]
  tasks          Task[]
  transactions   Transaction[]

  @@index([propertyId])
  @@index([ownerId])
  @@index([propertyId, status])
}

enum UnitStatus {
  ACTIVE
  INACTIVE
  MAINTENANCE
}

model UnitPhoto {
  id        String   @id @default(cuid())
  unitId    String
  url       String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)
}

// ==================== CHANNEL MANAGER ====================

model Channel {
  id         String  @id @default(cuid())
  name       String  @unique // airbnb, booking, expedia
  apiBaseUrl String
  active     Boolean @default(true)

  propertyChannels PropertyChannel[]
  reservations     Reservation[]
}

model PropertyChannel {
  id                String    @id @default(cuid())
  propertyId        String
  channelId         String
  externalListingId String
  syncEnabled       Boolean   @default(true)
  credentials       Json?     // Encrypted
  lastSyncAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  property Property @relation(fields: [propertyId], references: [id])
  channel  Channel  @relation(fields: [channelId], references: [id])

  @@unique([propertyId, channelId])
}

model CalendarBlock {
  id        String   @id @default(cuid())
  unitId    String
  startDate DateTime
  endDate   DateTime
  reason    String?
  createdAt DateTime @default(now())

  unit Unit @relation(fields: [unitId], references: [id])

  @@index([unitId, startDate, endDate])
}

// ==================== GUESTS ====================

model Guest {
  id           String    @id @default(cuid())
  tenantId     String
  name         String
  email        String?
  phone        String?
  document     String?   // CPF/Passport
  notes        String?
  isBlocked    Boolean   @default(false) // DNR list
  blockReason  String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  reservations Reservation[]

  @@unique([tenantId, email])
  @@index([tenantId, name])
}

// ==================== RESERVATIONS ====================

model Reservation {
  id                    String            @id @default(cuid())
  tenantId              String
  unitId                String
  channelId             String?
  guestId               String?
  externalReservationId String?
  guestName             String
  guestEmail            String?
  guestPhone            String?
  checkinDate           DateTime
  checkoutDate          DateTime
  numGuests             Int
  totalAmount           Decimal
  channelFee            Decimal           @default(0)
  cleaningFee           Decimal           @default(0)
  netAmount             Decimal
  status                ReservationStatus @default(CONFIRMED)
  notes                 String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt

  tenant       Tenant             @relation(fields: [tenantId], references: [id])
  unit         Unit               @relation(fields: [unitId], references: [id])
  channel      Channel?           @relation(fields: [channelId], references: [id])
  guest        Guest?             @relation(fields: [guestId], references: [id])
  events       ReservationEvent[]
  tasks        Task[]
  transactions Transaction[]
  messages     MessageLog[]

  @@index([tenantId, checkinDate])
  @@index([tenantId, status])
  @@index([unitId, checkinDate])
  @@index([guestId])
}

enum ReservationStatus {
  PENDING
  CONFIRMED
  CHECKED_IN
  CHECKED_OUT
  CANCELLED
  NO_SHOW
}

model ReservationEvent {
  id            String   @id @default(cuid())
  reservationId String
  eventType     String
  payload       Json?
  createdAt     DateTime @default(now())
  createdBy     String?

  reservation Reservation @relation(fields: [reservationId], references: [id])
}

// ==================== OPERATIONS ====================

model Task {
  id                  String     @id @default(cuid())
  tenantId            String
  unitId              String
  reservationId       String?
  recurringTemplateId String?
  type                TaskType
  title               String
  description         String?
  assignedToId        String?
  status              TaskStatus @default(PENDING)
  scheduledDate       DateTime
  completedAt         DateTime?
  notes               String?
  createdAt           DateTime   @default(now())
  updatedAt           DateTime   @updatedAt

  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  unit              Unit               @relation(fields: [unitId], references: [id])
  reservation       Reservation?       @relation(fields: [reservationId], references: [id])
  assignedTo        User?              @relation(fields: [assignedToId], references: [id])
  recurringTemplate RecurringTask?     @relation(fields: [recurringTemplateId], references: [id])
  checklist         TaskChecklist[]

  @@index([tenantId, scheduledDate])
  @@index([tenantId, status])
  @@index([unitId])
}

model RecurringTask {
  id             String              @id @default(cuid())
  tenantId       String
  propertyId     String?             // null = all properties
  type           TaskType
  title          String
  description    String?
  assignedToId   String?
  frequency      RecurringFrequency
  dayOfWeek      Int?                // 0-6 for weekly
  dayOfMonth     Int?                // 1-31 for monthly
  active         Boolean             @default(true)
  lastGeneratedAt DateTime?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  generatedTasks Task[]

  @@index([tenantId, active])
}

enum RecurringFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

enum TaskType {
  CLEANING
  MAINTENANCE
  INSPECTION
  OTHER
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

model TaskChecklist {
  id       String  @id @default(cuid())
  taskId   String
  item     String
  checked  Boolean @default(false)
  photoUrl String?

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
}

// ==================== COMMUNICATION ====================

model MessageTemplate {
  id          String         @id @default(cuid())
  tenantId    String
  name        String
  channel     MessageChannel
  triggerType MessageTrigger
  triggerDays Int            @default(0)
  subject     String?
  body        String
  active      Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  tenant Tenant       @relation(fields: [tenantId], references: [id])
  logs   MessageLog[]
}

enum MessageChannel {
  EMAIL
  WHATSAPP
  SMS
}

enum MessageTrigger {
  BOOKING_CONFIRMED
  BEFORE_CHECKIN
  ON_CHECKIN
  ON_CHECKOUT
  AFTER_CHECKOUT
}

model MessageLog {
  id            String         @id @default(cuid())
  reservationId String
  templateId    String?
  channel       MessageChannel
  recipient     String
  subject       String?
  body          String
  status        MessageStatus
  sentAt        DateTime?
  error         String?
  createdAt     DateTime       @default(now())

  reservation Reservation      @relation(fields: [reservationId], references: [id])
  template    MessageTemplate? @relation(fields: [templateId], references: [id])
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
}

// ==================== FINANCIAL ====================

model Transaction {
  id            String          @id @default(cuid())
  tenantId      String
  unitId        String
  reservationId String?
  type          TransactionType
  category      String
  amount        Decimal
  date          DateTime
  description   String?
  reconciled    Boolean         @default(false)
  createdById   String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  unit        Unit         @relation(fields: [unitId], references: [id])
  reservation Reservation? @relation(fields: [reservationId], references: [id])
  createdBy   User?        @relation(fields: [createdById], references: [id])

  @@index([tenantId, date])
  @@index([unitId, date])
  @@index([tenantId, type])
}

enum TransactionType {
  INCOME
  EXPENSE
}

model OwnerPayout {
  id          String       @id @default(cuid())
  ownerId     String
  periodStart DateTime
  periodEnd   DateTime
  grossAmount Decimal
  expenses    Decimal
  adminFee    Decimal
  netAmount   Decimal
  status      PayoutStatus @default(PENDING)
  paidAt      DateTime?
  receiptUrl  String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  owner Owner @relation(fields: [ownerId], references: [id])

  @@unique([ownerId, periodStart, periodEnd])
  @@index([ownerId, status])
}

enum PayoutStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
}

// ==================== ACTIVITY LOG ====================

model ActivityLog {
  id         String   @id @default(cuid())
  tenantId   String
  userId     String?
  action     String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType String   // property, reservation, task, etc.
  entityId   String?
  metadata   Json?    // Additional context
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([tenantId, createdAt])
  @@index([entityType, entityId])
}
